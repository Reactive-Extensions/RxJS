/*** @preserve Copyright (c) Microsoft Corporation.  All rights reserved.
* This code is licensed by Microsoft Corporation under the terms
* of the MICROSOFT REACTIVE EXTENSIONS FOR JAVASCRIPT AND .NET LIBRARIES License.
* See http://go.microsoft.com/fwlink/?LinkID=220762.
*/
(function(e,t){var n=typeof exports=="object"&&exports&&(typeof e=="object"&&e&&e==e.global&&(window=e),exports);typeof define=="function"&&define.amd?define(["rx","exports"],function(n,r){return e.Rx=t(e,r,n),e.Rx}):typeof module=="object"&&module&&module.exports==n?module.exports=t(e,module.exports,require("./rx")):e.Rx=t(e,{},e.Rx)})(this,function(e,t,n,r){function h(e,t){return e===t}function p(){}function m(e,t){return e.length===1&&Array.isArray(e[t])?e[t]:v.call(e)}function y(e){this.patterns=e}function b(e,t){this.expression=e,this.selector=t}function w(e,t,n){var r=e.get(t);if(!r){var i=new S(t,n);return e.set(t,i),i}return r}function E(e,t,n){var r,i;this.joinObserverArray=e,this.onNext=t,this.onCompleted=n,this.joinObservers=new g;for(r=0;r<this.joinObserverArray.length;r++)i=this.joinObserverArray[r],this.joinObservers.set(i,i)}var i=n.Observable,s=i.prototype,o=n.Internals.AnonymousObservable,u=i.throwException,a=n.Observer.create,f=n.SingleAssignmentDisposable,l=n.CompositeDisposable,c=n.Internals.AbstractObserver,d=n.Internals.inherits,v=Array.prototype.slice,g=function(){function e(){this.keys=[],this.values=[]}return e.prototype["delete"]=function(e){var t=this.keys.indexOf(e);return t!==-1&&(this.keys.splice(t,1),this.values.splice(t,1)),t!==-1},e.prototype.get=function(e,t){var n=this.keys.indexOf(e);return n!==-1?this.values[n]:t},e.prototype.set=function(e,t){var n=this.keys.indexOf(e);n!==-1&&(this.values[n]=t),this.values[this.keys.push(e)-1]=t},e.prototype.size=function(){return this.keys.length},e.prototype.has=function(e){return this.keys.indexOf(e)!==-1},e.prototype.getKeys=function(){return this.keys.slice(0)},e.prototype.getValues=function(){return this.values.slice(0)},e}();y.prototype.and=function(e){var t=this.patterns.slice(0);return t.push(e),new y(t)},y.prototype.then=function(e){return new b(this,e)},b.prototype.activate=function(e,t,n){var r=this,i=[];for(var s=0,o=this.expression.patterns.length;s<o;s++)i.push(w(e,this.expression.patterns[s],t.onError.bind(t)));var u=new E(i,function(){var e;try{e=r.selector.apply(r,arguments)}catch(n){t.onError(n);return}t.onNext(e)},function(){for(var e=0,t=i.length;e<t;e++)i[e].removeActivePlan(u);n(u)});for(s=0,o=i.length;s<o;s++)i[s].addActivePlan(u);return u},E.prototype.dequeue=function(){var e=this.joinObservers.getValues();for(var t=0,n=e.length;t<n;t++)e[t].queue.shift()},E.prototype.match=function(){var e,t,n,r,i,s=!0;for(t=0,n=this.joinObserverArray.length;t<n;t++)if(this.joinObserverArray[t].queue.length===0){s=!1;break}if(s){e=[],r=!1;for(t=0,n=this.joinObserverArray.length;t<n;t++)e.push(this.joinObserverArray[t].queue[0]),this.joinObserverArray[t].queue[0].kind==="C"&&(r=!0);if(r)this.onCompleted();else{this.dequeue(),i=[];for(t=0;t<e.length;t++)i.push(e[t].value);this.onNext.apply(this,i)}}};var S=function(){function e(t,n){e.super_.constructor.call(this),this.source=t,this.onError=n,this.queue=[],this.activePlans=[],this.subscription=new f,this.isDisposed=!1}return d(e,c),e.prototype.next=function(e){if(!this.isDisposed){if(e.kind==="E"){this.onError(e.exception);return}this.queue.push(e);var t=this.activePlans.slice(0);for(var n=0,r=t.length;n<r;n++)t[n].match()}},e.prototype.error=p,e.prototype.completed=p,e.prototype.addActivePlan=function(e){this.activePlans.push(e)},e.prototype.subscribe=function(){this.subscription.disposable(this.source.materialize().subscribe(this))},e.prototype.removeActivePlan=function(e){var t=this.activePlans.indexOf(e);this.activePlans.splice(t,1),this.activePlans.length===0&&this.dispose()},e.prototype.dispose=function(){e.super_.dispose.call(this),this.isDisposed||(this.isDisposed=!0,this.subscription.dispose())},e}();return s.and=function(e){return new y([this,e])},s.then=function(e){return(new y([this])).then(e)},i.when=function(){var e=m(arguments,0);return new o(function(t){var n=[],r=new g,i,s,o,f,c,h;h=a(t.onNext.bind(t),function(e){var n=r.getValues();for(var i=0,s=n.length;i<s;i++)n[i].onError(e);t.onError(e)},t.onCompleted.bind(t));try{for(s=0,o=e.length;s<o;s++)n.push(e[s].activate(r,h,function(e){var t=n.indexOf(e);n.splice(t,1),n.length===0&&h.onCompleted()}))}catch(p){u(p).subscribe(t)}i=new l,c=r.getValues();for(s=0,o=c.length;s<o;s++)f=c[s],f.subscribe(),i.add(f);return i})},n});
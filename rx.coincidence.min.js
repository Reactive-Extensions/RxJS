/*** @preserve Copyright (c) Microsoft Corporation.  All rights reserved.
* This code is licensed by Microsoft Corporation under the terms
* of the MICROSOFT REACTIVE EXTENSIONS FOR JAVASCRIPT AND .NET LIBRARIES License.
* See http://go.microsoft.com/fwlink/?LinkID=220762.
*/
(function(e,t){var n=typeof exports=="object"&&exports&&(typeof e=="object"&&e&&e==e.global&&(window=e),exports);typeof define=="function"&&define.amd?define(["rx","exports"],function(n,r){return e.Rx=t(e,r,n),e.Rx}):typeof module=="object"&&module&&module.exports==n?module.exports=t(e,module.exports,require("./rx")):e.Rx=t(e,{},e.Rx)})(this,function(e,t,n,r){function v(){}function m(e,t){return e===t}function w(e){var t,n;if(e&!1)return e===2;t=Math.sqrt(e),n=3;while(n<=t){if(e%n===0)return!1;n+=2}return!0}function E(e){var t,n,r;for(t=0;t<g.length;++t){n=g[t];if(n>=e)return n}r=e|1;while(r<g[g.length-1]){if(w(r))return r;r+=2}return e}function x(){return{key:null,value:null,next:0,hashCode:0}}function N(e,t){return e.groupJoin(this,t,function(){return c()},function(e,t){return t})}function C(e){var t=this;return new h(function(n){var r=new f,i=new s,u=new o(i);return n.onNext(d(r,u)),i.add(t.subscribe(function(e){r.onNext(e)},function(e){r.onError(e),n.onError(e)},function(){r.onCompleted(),n.onCompleted()})),i.add(e.subscribe(function(e){r.onCompleted(),r=new f,n.onNext(d(r,u))},function(e){r.onError(e),n.onError(e)},function(){r.onCompleted(),n.onCompleted()})),u})}function k(e){var t=this;return new h(function(n){var r,i=new a,l=new s(i),c=new o(l),h=new f;return n.onNext(d(h,c)),l.add(t.subscribe(function(e){h.onNext(e)},function(e){h.onError(e),n.onError(e)},function(){h.onCompleted(),n.onCompleted()})),r=function(){var t,s;try{s=e()}catch(o){n.onError(o);return}t=new u,i.disposable(t),t.disposable(s.take(1).subscribe(v,function(e){h.onError(e),n.onError(e)},function(){h.onCompleted(),h=new f,n.onNext(d(h,c)),r()}))},r(),c})}var i=n.Observable,s=n.CompositeDisposable,o=n.RefCountDisposable,u=n.SingleAssignmentDisposable,a=n.SerialDisposable,f=n.Subject,l=i.prototype,c=i.empty,h=n.Internals.AnonymousObservable,p=n.Observer.create,d=n.Internals.addRef,g=[1,3,7,13,31,61,127,251,509,1021,2039,4093,8191,16381,32749,65521,131071,262139,524287,1048573,2097143,4194301,8388593,16777213,33554393,67108859,134217689,268435399,536870909,1073741789,2147483647],y="no such key",b="duplicate key",S=function(){var e=0;return function(t){var n;if(t===r)throw new Error(y);return t.getHashCode!==r?t.getHashCode():(n=17*e++,t.getHashCode=function(){return n},n)}}(),T=function(e,t){this._initialize(e),this.comparer=t||m,this.freeCount=0,this.size=0,this.freeList=-1};return T.prototype._initialize=function(e){var t=E(e),n;this.buckets=new Array(t),this.entries=new Array(t);for(n=0;n<t;n++)this.buckets[n]=-1,this.entries[n]=x();this.freeList=-1},T.prototype.count=function(){return this.size},T.prototype.add=function(e,t){return this._insert(e,t,!0)},T.prototype._insert=function(e,t,n){this.buckets===r&&this._initialize(0);var i=S(e)&2147483647,s=i%this.buckets.length;for(var o=this.buckets[s];o>=0;o=this.entries[o].next)if(this.entries[o].hashCode===i&&this.comparer(this.entries[o].key,e)){if(n)throw b;this.entries[o].value=t;return}if(this.freeCount>0){var u=this.freeList;this.freeList=this.entries[u].next,--this.freeCount}else this.size===this.entries.length&&(this._resize(),s=i%this.buckets.length),u=this.size,++this.size;this.entries[u].hashCode=i,this.entries[u].next=this.buckets[s],this.entries[u].key=e,this.entries[u].value=t,this.buckets[s]=u},T.prototype._resize=function(){var e=E(this.size*2),t=new Array(e);for(r=0;r<t.length;++r)t[r]=-1;var n=new Array(e);for(r=0;r<this.size;++r)n[r]=this.entries[r];for(var r=this.size;r<e;++r)n[r]=x();for(var i=0;i<this.size;++i){var s=n[i].hashCode%e;n[i].next=t[s],t[s]=i}this.buckets=t,this.entries=n},T.prototype.remove=function(e){if(this.buckets!==r){var t=S(e)&2147483647,n=t%this.buckets.length,i=-1;for(var s=this.buckets[n];s>=0;s=this.entries[s].next){if(this.entries[s].hashCode===t&&this.comparer(this.entries[s].key,e))return i<0?this.buckets[n]=this.entries[s].next:this.entries[i].next=this.entries[s].next,this.entries[s].hashCode=-1,this.entries[s].next=this.freeList,this.entries[s].key=null,this.entries[s].value=null,this.freeList=s,++this.freeCount,!0;i=s}}return!1},T.prototype.clear=function(){var e,t;if(this.size<=0)return;for(e=0,t=this.buckets.length;e<t;++e)this.buckets[e]=-1;for(e=0;e<this.size;++e)this.entries[e]=x();this.freeList=-1,this.size=0},T.prototype._findEntry=function(e){if(this.buckets!==r){var t=S(e)&2147483647;for(var n=this.buckets[t%this.buckets.length];n>=0;n=this.entries[n].next)if(this.entries[n].hashCode===t&&this.comparer(this.entries[n].key,e))return n}return-1},T.prototype.count=function(){return this.size-this.freeCount},T.prototype.tryGetEntry=function(e){var t=this._findEntry(e);return t>=0?{key:this.entries[t].key,value:this.entries[t].value}:r},T.prototype.getValues=function(){var e=0,t=[];if(this.entries!==r)for(var n=0;n<this.size;n++)this.entries[n].hashCode>=0&&(t[e++]=this.entries[n].value);return t},T.prototype.get=function(e){var t=this._findEntry(e);if(t>=0)return this.entries[t].value;throw new Error(y)},T.prototype.set=function(e,t){this._insert(e,t,!1)},T.prototype.containskey=function(e){return this._findEntry(e)>=0},l.join=function(e,t,n,r){var i=this;return new h(function(o){var a=new s,f=!1,l=0,c=new T,h=!1,p=0,d=new T;return a.add(i.subscribe(function(e){var n,i,s=l++,h=new u,p,m;c.add(s,e),a.add(h),i=function(){return c.remove(s)&&c.count()===0&&f&&o.onCompleted(),a.remove(h)};try{n=t(e)}catch(g){o.onError(g);return}h.disposable(n.take(1).subscribe(v,o.onError.bind(o),function(){i()})),m=d.getValues();for(var y=0;y<m.length;y++){try{p=r(e,m[y])}catch(b){o.onError(b);return}o.onNext(p)}},o.onError.bind(o),function(){f=!0,(h||c.count()===0)&&o.onCompleted()})),a.add(e.subscribe(function(e){var t,i,s=p++,f=new u,l,m;d.add(s,e),a.add(f),i=function(){return d.remove(s)&&d.count()===0&&h&&o.onCompleted(),a.remove(f)};try{t=n(e)}catch(g){o.onError(g);return}f.disposable(t.take(1).subscribe(v,o.onError.bind(o),function(){i()})),m=c.getValues();for(var y=0;y<m.length;y++){try{l=r(m[y],e)}catch(g){o.onError(g);return}o.onNext(l)}},o.onError.bind(o),function(){h=!0,(f||d.count()===0)&&o.onCompleted()})),a})},l.groupJoin=function(e,t,n,r){var i=this;return new h(function(a){var l=new s,c=new o(l),h=0,p=new T,m=0,g=new T;return l.add(i.subscribe(function(e){var n,i,s,o=h++,m,y,b,w=new f;p.add(o,w);try{y=r(e,d(w,c))}catch(E){m=p.getValues();for(s=0;s<m.length;s++)m[s].onError(E);a.onError(E);return}a.onNext(y),b=g.getValues();for(s=0;s<b.length;s++)w.onNext(b[s]);var S=new u;l.add(S),i=function(){p.remove(o)&&w.onCompleted(),l.remove(S)};try{n=t(e)}catch(E){m=p.getValues();for(s=0;s<m.length;s++)m[s].onError(E);a.onError(E);return}S.disposable(n.take(1).subscribe(v,function(e){m=p.getValues();for(var t=0,n=m.length;t<n;t++)m[t].onError(e);a.onError(e)},function(){i()}))},function(e){var t,n;n=p.getValues();for(t=0;t<n.length;t++)n[t].onError(e);a.onError(e)},a.onCompleted.bind(a))),l.add(e.subscribe(function(e){var t,r,i,s=m++;g.add(s,e);var o=new u;l.add(o);var f=function(){g.remove(s),l.remove(o)};try{t=n(e)}catch(c){i=p.getValues();for(r=0;r<i.length;r++)i[r].onError(c);a.onError(c);return}o.disposable(t.take(1).subscribe(v,function(e){i=p.getValues();for(var t=0;t<i.length;t++)i[t].onError(e);a.onError(e)},function(){f()})),i=p.getValues();for(r=0;r<i.length;r++)i[r].onNext(e)},function(e){var t,n;n=p.getValues();for(t=0;t<n.length;t++)n[t].onError(e);a.onError(e)})),c})},l.buffer=function(e,t){return arguments.length===1&&typeof arguments[0]!="function"?C.call(this,e).selectMany(function(e){return e.toArray()}):typeof e=="function"?k(e).selectMany(function(e){return e.toArray()}):N(this,e,t).selectMany(function(e){return e.toArray()})},l.window=function(e,t){return arguments.length===1&&typeof arguments[0]!="function"?C.call(this,e):typeof e=="function"?k.call(this,e):N.call(this,e,t)},n});